!function(){var e=window.infoBox.sharedObjectId;const t=window[e],r=window.infoBox.extUrl;delete window.infoBox,delete window[e];let s;t.helpers={getNegotiation:function(e,t){try{return s=s||new o(e,t)}catch(e){return null}},getResourceStock:function(){try{return ResourceStock}catch(e){return null}},getHelperNego:function(){try{return Negotiation}catch(e){}}};const a={AllAge:0,NoAge:0,StoneAge:1,BronzeAge:2,IronAge:3,EarlyMiddleAge:4,HighMiddleAge:5,LateMiddleAge:6,ColonialAge:7,IndustrialAge:8,ProgressiveEra:9,ModernEra:10,PostModernEra:11,ContemporaryEra:12,TomorrowEra:13,FutureEra:14,ArcticFuture:15,OceanicFuture:16,VirtualFuture:17,SpaceAgeMars:18,SpaceAgeAsteroidBelt:19,SpaceAgeVenus:20,SpaceAgeJupiterMoon:21,NextEra:22};class o{constructor(e,t){this.Tables={},this.PlaceCount=5,this.resourcesModel=e,this.resourcesDefinition=t}async start(e){this.CurrentTry=1,this.CurrentTable=null;var t,r=e.possibleCosts.resources.h;const s=[];for(t in this.GoodsOrdered=s,r)s.push({id:-1,resourceId:t,plannedPos:-1,canOccur:[...new Array(this.PlaceCount).keys()],hasToOccur:0,amount:r[t],value:this.GetGoodValue(t)});this.GoodCount=s.length,s.sort((e,t)=>this.goodButtonCompare(e.resourceId,t.resourceId)),s.forEach((e,t)=>e.id=t),s.sort((e,t)=>e.value-t.value),s.forEach((e,t)=>e.plannedPos=t),this.updateInitialPermutation(),this.TryCount=this.resourcesModel.getResourceValueById("negotiation_game_turn")||3,this.Guesses=[],this.GuessesSuggestions=[];e=this.TryCount+"_"+this.GoodCount,e=await this.GetTable(e);this.CurrentTable=e,this.updateNextGuess()}GetGoodValue(t){let r=0;const s=this.resourcesDefinition.getResourceDefinition;if("money"===t)r=0;else if("supplies"===t)r=50;else if("medals"===t){var o=localStorage.getItem("NegotiationSaveMedals");r="false"===o?75:3e3}else if("promethium"===t)r=3500;else if("orichalcum"===t)r=4e3;else{if("false"===localStorage.getItem("NegotiationSaveCurrentEraGoods"))r=100;else{o=s(t).era;let e=a[o];void 0===e&&(e=20),r=100*e}o=this.resourcesModel.getResourceValueById(t);r+=void 0===o||0===o?99:1/o}return r}goodButtonCompare(e,t){const s=this.resourcesDefinition.getResourceDefinition;function r(e){const t=s(e);var r;return"AllAge"===t.era?100:(e=!!t.abilities.get("specialResource"),(0===(r=a[t.era])?200:r)+(e?400:0))}var o,n;return e===t?0:(o=r(e))===(n=r(t))?t<e?1:-1:o-n}GetTable(t){var e;return void 0===this.Tables[t]?(e=r+"src/extra/tables/",fetch(e+t+".zip").then(function(e){return 200===e.status||0===e.status?Promise.resolve(e.blob()):Promise.reject(new Error(e.statusText))}).then(JSZip.loadAsync).then(function(e){return e.file(t+".json").async("uint8array")}).then(e=>{e=JSON.parse((new TextDecoder).decode(e));return this.Tables[t]=e}).catch(e=>null)):Promise.resolve(this.Tables[t])}getGuess(){try{const e=this.GuessesSuggestions[this.Guesses.length];let r=!1;const s={},t=e.map(e=>{var t;return e?(t=e.resourceId,e.stock=this.resourcesModel.getResourceValueById(t),e.stock<e.amount&&(r=!0),s[t]=(s[t]||0)+e.amount,e):null});return r||t.some(e=>e&&s[e.resourceId]>e.stock)&&(r=!0),{suggestion:t,notEnough:r}}catch(e){return null}}updateInitialPermutation(){const r=this.GoodsOrdered;this.PlaceMutation=[...new Array(this.PlaceCount).keys()].sort((e,t)=>{return e===t?0:(e<r.length?r[e].id:255)-(t<r.length?r[t].id:255)}).map((e,t)=>[e,t]).sort((e,t)=>e[0]-t[0]).map(([,e])=>e)}updateNextGuess(){if(this.CurrentTable){var t=this.GoodsOrdered,r=this.PlaceMutation,s=this.CurrentTable.gu;const o=[];for(let e=0;e<s.length;e++)o[r[e]]=255===s[e]?null:t[s[e]];this.GuessesSuggestions[this.CurrentTry-1]=o}}submitTurn(e){var t=this.CurrentTry;const r=this.GoodsOrdered;var s,o,e=e.turnResult.slots;const n=[...new Array(this.PlaceCount).keys()].map(()=>({good:null,match:0}));this.Guesses.push(n);let a=0;for(s of e){var u=s.state;const d=s.resourceId,g=s.slotId||0,f=n[g],p=r.find(e=>e.resourceId===d);if((n[g].good=p).canOccur=p.canOccur.filter(e=>e!==g),"correct"===u){f.match=0,p.hasToOccur<t&&(p.hasToOccur=0);for(var i of r)i.canOccur=i.canOccur.filter(e=>e!==g)}else"wrong_person"===u?(f.match=1,p.hasToOccur=t):(f.match=2,p.canOccur=[],p.hasToOccur=0),a++}let c=0;for(o of r)0<o.hasToOccur&&(c++,1===o.canOccur.length&&this.updateKnownPosition(o));if(a===c)for(let e=0;e<r.length;e++){const m=r[e];0===m.hasToOccur&&(m.canOccur=[])}this.CurrentTry=t+1;var l=this.PlaceMutation;let h=0;for(let e=0;e<5;e++)h=(h*=4)+n[l[e]].match;this.CurrentTable=this.CurrentTable.r[h],this.updateNextGuess()}updateKnownPosition(e){if(0!==e.hasToOccur&&1===e.canOccur.length){const s=e.canOccur[0];for(var t of this.GoodsOrdered){var r;t!==e&&(r=t.canOccur.length,t.canOccur=t.canOccur.filter(e=>e!==s),r!=t.canOccur.length&&this.updateKnownPosition(t))}}}}}();