import{Panel,PanelHeader,Card,Switch,StatusPanel}from"../components/index.js";const sharedObjectId=window.infoBox.sharedObjectId,sharedObject=window[sharedObjectId],_=sharedObject.i18n["_"],{Component,html}=window.neverland,{useSelector,useDispatch,store}=sharedObject.store;function closePanelHandler(){const e=useDispatch();e({type:"BOT:GVG_PANEL_VISIBLE",payload:!1})}function onPosChange(e,t){const a=sharedObject.bgApi,n=useDispatch();n({type:"PANEL:SET_POSITION",payload:{posX:t.posX,posY:t.posY,panelId:e}});t=store.getState().botConfig;a.setConfig(t)}function propBlock(e,t){return html`<div class="sector-info__prop"><span class="sector-info__title">${e}</span> <span class="sector-info__value">${t}</span></div>`}function onPresetChanged(e,t){changePreset(e,t.target.value)}function changePreset(e,t){const a=sharedObject.bgApi,n=useDispatch();n({type:"GVG_PRESET_CHANGED",payload:{type:e,value:t}});e=store.getState().botConfig;a.setConfig(e)}function attackCommand(){const e=sharedObject.bgApi;var t=store.getState();const a=useDispatch();let n=t.botConfig?.gvgPanel?.attackPreset;if(!n){var o=Object.keys(t.botConfig.armyConfig)[0];if(!o)return void a({type:"GVG_PANEL:SET_STATUS",payload:{type:"error",text:"Не выбраны пресеты атаки или защиты"}});changePreset("siege",n=o)}o=t.botConfig.armyConfig[n];o&&(t=t.gvgPanel.dumbMode,e.gvgAttack(o,t))}function stopCommand(){const e=sharedObject.bgApi;e.gvgStop()}function placeArmyCommand(){const e=sharedObject.bgApi;var t=store.getState();const a=useDispatch();let n=t.botConfig?.gvgPanel?.siegePreset;if(!n){var o=Object.keys(t.botConfig.armyConfig)[0];if(!o)return void a({type:"GVG_PANEL:SET_STATUS",payload:{type:"error",text:_("panels.gvg.no_presets")}});changePreset("siege",n=o)}o=t.botConfig.armyConfig[n];o&&(t=t.gvgPanel.dumbMode,e.gvgPlaceArmy(o,t))}function autoCommand(){const e=sharedObject.bgApi,t=useDispatch();var a=store.getState();let n=a.botConfig?.gvgPanel?.attackPreset,o=a.botConfig?.gvgPanel?.siegePreset;if(!n||!o){var s=Object.keys(a.botConfig.armyConfig)[0];if(!s)return void t({type:"GVG_PANEL:SET_STATUS",payload:{type:"error",text:_("panels.gvg.no_presets")}});n=n||s,o=o||s,changePreset("attack",n),changePreset("siege",o)}var s=a.botConfig.armyConfig[n],l=a.botConfig.armyConfig[o];s&&l?(a=a.gvgPanel.dumbMode,e.autoGvg(s,l,a)):t({type:"GVG_PANEL:SET_STATUS",payload:{type:"error",text:_("panels.gvg.no_presets")}})}function enableDumbMode(e,t){const a=useDispatch();a({type:"GVG_DUMB_MODE",payload:t})}function formatHP(e){return void 0===e?"    ":e<10?` ${e} `:e}const PanelBody=Component(()=>{var e=useSelector(e=>e),t=e.gvgPanel,a=e.gvgPanel.dumbMode,n=t.sector,o=n?.canAttack||a,a=n?.canPlaceArmy||a,s=e.botConfig.armyConfig,t=t.status;const l=e.botConfig?.gvgPanel?.siegePreset||"",c=e.botConfig?.gvgPanel?.attackPreset||"";var g=t?.text||_("panels.gvg.ready"),t=t?.type||"ok";return html`<div class="panel-body"><div class="gvg-sector">${Card(null,html`<div class="sector-info">${propBlock("❤HP:",formatHP(n.hitpoints))} ${propBlock(_("panels.gvg.sieged"),n.siegeId?"✅":"❌")} ${propBlock(_("panels.gvg.defence"),n.isProtected?"✅":"❌")} ${propBlock(_("panels.gvg.attack_allowed"),n.canAttack?"✅":"❌")} ${propBlock(_("panels.gvg.siege_allowed"),n.canPlaceArmy?"✅":"❌")}</div>`,!0)}</div>${Switch({label:_("panels.gvg.dumb_mode"),id:"dumbMode",checked:e.botConfig.dumbMode,handler:enableDumbMode})}<div class="controls"><div class="sector-control"><span class="title">${_("panels.gvg.attack")}</span> <span class="control-label">${_("panels.gvg.preset")}</span> <select class="form-control" value=${c} onChange=${onPresetChanged.bind(null,"attack")}>${Object.keys(s).map(e=>html`<option value=${e} selected=${e===c}>${e}</option>`)}</select> <button class="btn btn-primary" onclick=${attackCommand} disabled=${!o}>${_("panels.gvg.attack")}</button> <button class="btn btn-danger mt-1" onclick=${stopCommand}>${_("panels.bg.stop")}</button></div><div class="sector-control"><span class="title">${_("panels.gvg.siege")}</span> <span class="control-label">${_("panels.gvg.preset")}</span> <select class="form-control" value=${l} onChange=${onPresetChanged.bind(null,"siege")}>${Object.keys(s).map(e=>html`<option value=${e} selected=${e===l}>${e}</option>`)}</select> <button class="btn btn-primary" onclick=${placeArmyCommand} disabled=${!a}>${_("panels.gvg.place_siege")}</button></div><div class="sector-control"><span class="title">${_("panels.gvg.auto")}</span> <button class="btn btn-primary" onclick=${autoCommand} disabled=${!a}>${_("panels.gvg.siege_plus_attack")}</button> <button class="btn btn-danger mt-1" onclick=${stopCommand}>${_("panels.bg.stop")}</button></div></div>${StatusPanel({type:t,text:g,label:_("status")})}</div>`}),GVGPanel=Component(()=>{var e=useSelector(e=>e),t=e.gvgPanel["visible"],{posX:a,posY:n}=e.botConfig.gvgPanel,o=e.gvgPanel.sector,{isScriptInited:e,isActive:s}=e.status,e=e&&s&&t,s=html`${_("panels.gvg.sector")} <b>${o.name&&o.position?`${o.name} [${o.position.x} ${o.position.y}] - (${o.ownerId<=0?"NPC":""+o.ownerName})`:_("panels.gvg.no_sector")}</b>`;return e?html`${Panel({id:"gvgPanel",panelId:"gvgPanel",visible:t,header:PanelHeader({onPosChange:onPosChange.bind(null,"gvgPanel"),closable:!0,title:s,closeHandler:closePanelHandler}),body:PanelBody(),position:{posX:a,posY:n}})}`:""});export default GVGPanel;